# 工具设计理念与规范

本文档定义了项目中所有工具的设计原则、数据结构和行为规范，旨在确保工具集的一致性、可预测性和对大语言模型（LLM）的友好性。

## 1. 整体思路 (Shell-Native)

- **核心架构**: 项目采用 “Shell-Native” 架构。Node.js 作为胶水层，负责解析 MCP 请求，并通过 `ShellJS` 调用跨平台的 Shell 命令来执行核心逻辑。这种方法增强了系统的透明度、可维护性和执行效率。
- **操作单元**: 所有文件操作都以 **整行** 作为最小的读写单元。工具的输入和输出都应基于行内容或行号，避免复杂的字符级操作。
- **返回格式**: 工具的返回值应尽可能扁平、简洁。优先使用纯文本或简单的 YAML 格式，避免深度嵌套的数据结构，以简化 LLM 对结果的解析和使用。

## 2. 知识仓库目录结构

每个知识库都是一个独立的目录，其内部结构如下：

-   `./entities/`: 存放所有的知识实体文件（`.md`）。
-   `./trash/`: 存放被软删除的实体文件，文件名会附加时间戳。
-   `./backups/`: 存放知识库的备份压缩文件。
-   `./journeys/`: 存放所有的编辑日志（当前尚未完全实现）。
-   `./meta.md`: 存放知识库的元数据和使用规范。

## 3. 文件结构定义

每个实体文件（`.md`）都由两部分组成：**Front Matter** 和 **正文**。

### Front Matter 定义

Front Matter 用于存储实体的结构化元数据，遵循以下规范：

- **格式**: 采用简化的、基于行的 YAML 格式。
- **结构**: 只能包含一级键值对，每个键值对占据单行 (`key: value`)。
- **类型**: 键和值都必须是字符串。
- **前缀约定**: 使用键的前缀来区分不同类型的元数据。
  - `relation <type>`: 定义一个关系 (例如: `relation knows: person-b`)。
- **预设键**:
  - `date modified`: 修改日期 (例如: `date modified: 2024-01-01`)
  - `date created`: 创建日期 (例如: `date created: 2023-12-31`)
  - `aliases`: 实体的别名，用逗号分隔 (例如: `aliases: alias1, alias2`)

**示例:**
```markdown
---
entity type: person
aliases: John Doe, Johnny
date created: 2025-10-31
relation knows: person-b
---
```

### 正文 (Body) 定义

正文用于记录关于实体的非结构化或半结构化的详细知识。

- **结构**: 正文内容使用 Markdown 格式。
- **层级**: 章节标题应 **仅使用 H2 (`##`) 级别** 来组织内容。这有助于保持结构扁平，便于工具进行解析和编辑。
- **内容**: 正文记录对实体的具体观察、详细描述、相关事件或任何其他详细知识。
- **TOC 规范**: 对于特定类型的实体（如 `person`, `project`），其推荐的正文章节结构（TOC）通常会在知识库根目录的 `meta.md` 文件中进行定义和描述。

## 4. meta.md 定义

`meta.md` 是知识库的“说明书”和“配置文件”，它是一个标准的 Markdown 文件，用于：

- **描述用法**: 提供关于如何使用当前知识库的指南和最佳实践。
- **定义实体类型**: 列出并描述推荐使用的实体类型（例如 `person`, `organization`, `concept`）。
- **推荐 TOC**: 为不同的实体类型提供推荐的 Markdown 正文章节结构（Table of Contents），指导用户和 LLM 如何组织内容。
- **推荐关系方案**: 描述建议使用的关系类型（`relation types`）及其使用场景，促进知识图谱的一致性。

## 5. 注意事项和尽力避免

- **避免复杂数据结构**: 工具的输入和输出应保持简单。例如，LLM 更容易生成一个字符串列表，而不是一个复杂的嵌套 JSON 对象。
- **行级操作**: 所有编辑操作都应以行为单位。这简化了实现，并使 LLM 能够通过提供上下文行来精确定位要修改的内容。
- **幂等性**: 在可能的情况下，工具应设计为幂等的。多次执行相同的操作应产生相同的结果。
- **明确的错误信息**: 当操作失败时，返回清晰、可操作的错误信息，帮助 LLM 理解失败的原因并进行修正。
- **优先使用精确匹配**: 在进行内容删除或替换时，优先使用精确的、多行的 `old_content` 匹配，而不是依赖行号，这使得操作更加稳健。
