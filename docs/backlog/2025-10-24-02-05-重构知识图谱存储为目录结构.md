# 需求: 重构知识图谱存储为目录结构

- **状态**: 分析与设计
- **优先级**: 高

## 1. 目标

对项目的核心存储机制进行重构，从使用单一的 YAML 文件转变为使用文件系统目录结构来管理知识图谱。该变更旨在提升系统的透明度、可维护性、版本控制友好性，并增强与现有 Markdown 生态（如 Obsidian）的兼容性。

## 2. 核心变更

1.  **目录作为图谱**: `MEM_PATH` 环境变量将指向一个目录，该目录本身代表整个知识图谱。
2.  **文件作为实体**: 目录中的每个 `.md` 文件代表一个知识实体。文件名（不含 `.md` 扩展名）即为实体的唯一名称 (`name`)。
3.  **元数据文件 (`meta.md`)**: 在知识图谱根目录下创建一个 `meta.md` 文件，用于存储图谱的元信息。这可能包括但不限于：
    -   图谱的使用说明 (原 `manual`)
    -   实体和关系类型的定义或统计
4.  **编辑日志文件 (`journey.yaml`)**: 在知识图谱根目录下创建一个 `journey.yaml` 文件。该文件是一个包含所有操作记录的数组，新的日志条目仅追加到末尾。每个条目都是一个包含以下字段的对象：
    -   `timestamp unix`: 操作发生的 Unix 时间戳。
    -   `local time`: 人类可读的本地时间字符串。
    -   `action with parameters`: 一个描述操作和其参数的字符串。
    -   `is_success`: 一个布尔值，表示操作是否成功。
    -   `added contents`: 一个数组，记录本次操作中新增的实体及其内容。
    -   `deleted contents`: 一个数组，记录本次操作中删除的实体及其内容。

## 3. 预期收益

- **简化备份**: 对整个目录进行 `zip` 压缩即可完成备份。
- **版本控制友好**: 每个实体的变更都是一个文件的变更，便于使用 `git diff` 进行追踪。
- **生态兼容**: 可直接使用 Obsidian, VS Code 等工具查看和编辑知识实体。

## 4. 实体文件格式 (`.md`)

为了在兼容 Markdown 生态的同时结构化地存储实体信息，我们采用 YAML Front Matter 格式。每个 `.md` 文件的结构如下：

```markdown
---
entity type: <string>
aliases:
  - <string>
date created: <datetime>
date modified: <datetime>
relations:
  - relation type: <string>
    relation to: <string>
---

这里是关于该实体的非结构化笔记和描述，可以是任意 Markdown 内容。
```

### 4.1. Front Matter 字段详解

-   **`entity type` (必需)**: 一个字符串，用于定义实体的类型（例如 `Person`, `Location`, `Concept`）。
-   **`aliases` (可选)**: 一个字符串数组，用于存储该实体的别名或替代名称。
-   **`date created` (自动生成)**: 实体首次创建时的时间戳，格式为 `YYYY-MM-DD`。
-   **`date modified` (自动更新)**: 实体内容或元数据每次被修改时的时间戳，格式为 `YYYY-MM-DD`。
-   **`relations` (可选)**: 一个对象数组，用于定义实体间的关系。每个对象包含：
    -   `relation type`: 关系的类型（例如 `knows`, `located in`）。
    -   `relation to`: 关系指向的另一个实体的名称（即另一个 `.md` 文件的文件名，不含扩展名）。

### 4.2. 文件正文

Front Matter `---` 分隔符之后的部分是文件的主体。它可以包含任意格式的 Markdown 文本，用于对实体进行详细的、非结构化的描述。这部分内容不会被程序直接解析为结构化数据，但可以被用户或其他工具（如 Obsidian）自由编辑和查看。

### 4.3. 文件名规范

为了确保跨平台的兼容性和命令行友好性，实体名称在映射到 `.md` 文件名时，需遵循以下规范：

-   **字符集**: 文件名仅允许包含中文字符、小写英文字母 (a-z) 和数字 (0-9)。
-   **净化规则**: 原始实体名称中的所有空格、特殊符号（如 `_`, `/`, `.`）等，都应被替换为单个横线 `-`。
-   **大小写**: 所有英文字母都应被强制转换为小写。
-   **冗余处理**: 如果替换后出现连续的多个横线，应合并为单个横线。
-   **唯一性**: 程序在创建实体时必须保证最终生成的文件名是唯一的。
