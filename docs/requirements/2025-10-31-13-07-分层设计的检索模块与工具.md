# 需求：分层设计的检索模块与工具

**状态：已完成**

为了提供灵活且强大的知识检索功能，我们需要设计一套分层的检索能力，从底层的检索模块到上层的检索工具。

## 第一层：`retrieval` 模块 (基础检索能力)

这一层提供最基础的、基于 `grep` 等 shell 命令的文本匹配能力。

- **`src/v2/retrieval/retrieval.ts`**:
  - **`findFilesByName(libraryName, glob_pattern)`**:
    - **功能**: 在指定知识库的 `entities` 目录中，根据 `glob` 模式匹配文件名。
    - **实现**: 使用 `shell.ls`。
    - **返回**: 匹配的文件名列表。
  - **`grepInFiles(libraryName, file_glob_pattern, content_regex_pattern)`**:
    - **功能**: 在匹配 `file_glob_pattern` 的文件内容中，搜索匹配 `content_regex_pattern` 的行。
    - **实现**: 使用 `shell.grep`。
    - **返回**: 返回一个对象，其中 key 是文件名，value 是匹配的行数组。

## 第二层：结构化数据检索工具

这一层利用 `retrieval` 模块的能力，专注于从文件的 Front Matter 中检索结构化的元数据。

- **`find_relations(libraryName, to_entity?, relation_type?)`**
  - **功能**: 在整个知识库中，根据“关系目标”或“关系类型”搜索关系。
  - **实现**:
    1.  使用 `findFilesByName` 获取所有实体文件。
    2.  遍历文件，读取 Front Matter。
    3.  在 Front Matter 行中匹配关系。
  - **返回**: 找到的关系列表。

- **`find_entities_by_metadata(libraryName, metadata_pattern)`**
  - **功能**: 通过在 Front Matter 中搜索精确的 `key: value` 字符串来查找实体。
  - **实现**:
    1.  构造一个 `grep` 友好的 `metadata_pattern`。
    2.  使用 `grepInFiles` 在所有实体文件中搜索该模式。
  - **返回**: 匹配的实体名称列表。
